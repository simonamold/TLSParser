import os
import logging
from parser.tls_record import TLSRecord 
from common.exceptions import *
from parser.tls_stream_parser import TLSStreamParser
from tools.test_data import *
from ui.gui import run_gui

logging.basicConfig(level=logging.DEBUG, filename='tls_parser.log', filemode='w', 
                    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)
handler = logging.FileHandler(filename='tls_parser.log')
formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
handler.setFormatter(formatter)
logger.addHandler(handler)

def main():

    sample = bytes.fromhex(
    "16 03 01 00 43"                        # TLS Record Header (type: handshake, version: 1.0, length: 67)
    "01 00 00 3f"                          # Handshake Header (ClientHello, length: 63)
    "03 03"                                # ClientHello Version: TLS 1.2
    "5b 90 1c 84 53 2f 12 c7 4a 66 a2 1f 78 54 9b 78"     # Random (first half)
    "63b39e916d15af91f1334f0cd1874ef2"     # Random (second half)
    "00"                                   # Session ID length: 0
    "00 04"                                # Cipher Suites length: 4
    "00 2f 00 35"                          # Cipher Suites: TLS_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA
    "01"                                   # Compression Methods Length: 1
    "00"                                   # Compression Method: null
    "00 12"                                # Extensions length: 18
    "00 10"                                # Extension Type: ALPN (0x0010)
    "00 0e"                                # Extension Length: 14
    "00 10"                                # ALPN protocol name list length: 16
    "02 68 32"                             # Protocol 1: "h2"
    "08 68 74 74 70 2f 31 2e 31"  
    )

    # test_bytes= bytes.fromhex("16030100")
    # test = TLSRecord(test_bytes)
   
    # test.parse()
   
    #ws_client_hello = bytes.fromhex("160301071d0100071903030620ffa650bedd452bf332a1f7432fa5f5e1da47de91551884a12dccdf29de9920d9aaea3200eb5cb4c4c05f53f7f7a1efed7b1d04516a3eba35f2aea48630dfe600203a3a130113021303c02bc02fc02cc030cca9cca8c013c014009c009d002f0035010006b01a1a0000002b000706dada0304030300230000000500050100000000ff01000100003304ef04ed2a2a00010011ec04c0fc689487859242f2b24f2c92b90aaf1642bb47712918a97deb465ed98b3fc700101f1a5e322267196a5a682a5a6b011c1e84211824c36cec62d6884d82a1cb826bad7d457bf6b37e869a5b291881cc76aead8b06458282f1460b073206c1d71e939ac4876a1dfa2267d88b01d91caf0ca60d4184548fb7ba390a85604449004c3b8df53518f85b212b85e4195c05b921954bcb55f013a8d722de6093d34773a6a507f6e8bc3f744611b408a1a26b52b90aa3a0637518ce11e94949d45f88e948af7bcb25b32d5c946a7f6059512b7871a91a9fa6915a762592f66b020429045250b72c385187074d132b34b91de2975d8a285bd6c024da5013ec99ccc239b23cc0529e052f2c6959b4569be162545e561fb1929a5e4463a3550828f18fe6655f47f69db23bca35d0577729176468384feaa96a4346a506766150364f6647a50061a3e983f0669217ac925b621481abc70cda0be04b2929ebb008b0473d708f2adbb20872ccf0f45694003471c51f16b38f9b007f0c352d6d94b50ed412e7c61b7faa34c74914d1197ecd1806918309b4bb20a5ec0a134715ae87c461668bff8ca5cdd4abeef91082b38d58631a536a1f691a4dbe212380e15f532a91e8d24bb65b5fc10754880624ace8c7ae7933cdd6103968c733caaa2684a96455cf9c50948e971dd81c7e9e775525556f4407caafaac349c9c163f65f5c6bb8f093802562501c1a6c2a41683b0b13f645cf4be48fff22a7f7144a22b527389419134836501212698a3fde328975184a9c6a67f4914c50e26d1dd438c9c820eff073c5d11fba5926fd105668186bc11a1462416d1d242bca785981928ab3473299407df76a59c4c9a25330a4eb477e23a325712114b58931659c652560584eab1d18836c5ecc7ff57a558443ab02b077ef26962d22af58739665832b6a8b3f6df100c774018424344c9629400aa1e8a97b0ae67d997411d8a538fe2a49b7e7370cbc88a673b3f89561f748ace1b5712da7c49ab3c49b0209c6e03e608153c9b686d1911413479b1488a0448874b77486a7a191d1b54dcef10bd2a3a9d8ab984771bae270c2e0a19a1b792b98226321e2b0d8a78a6f768592a96e6a557e088a18d81b434b1133aaa478503c56111194b4192736fb5def40cf1c564c710c169045a17b2434507a2daa38b55649aa91768f988a0c09da387a148051e36d1bd39dbaf7607dca8ab2b33546869cbb328951b73728c98c1a6c61c746cf1d576391882d1c4ba729745424a2c5038b6548c4aa91a754a6ba233fcb61d657333aeb4747f4be649a658fcc96e5019538934538162f22c69f7da4856e2b934c5219db9829222738fcf49a1f76491ceb4294d7a92d981ce45cbd5b87965cba1bba18ae81e0314ad7bae41c78894147655304dc28a6abb271aa6149b8f78277e4402088ce8d198998b9ad7ddc18e5045bb8149f18ea1ec95619ba29cc05c91c434bcdbbdc766b276119f32c53c4b276d975167a35ead11d86b5a31873b1c39a575c0856d9a3b8d88549b6939a2cd32193710286f15b613ab6de467599e67a063031755956d7da5a94189caf513350e92cbe39890ce091176159a8671d63108dc93a77553bb962151ad37295e417af4407950c654a791e404d4b7ec9bcaa050a0faf3255ee5e30000ebdb74901afdbe718318d55016f5e6c09db4a77dad2d0c4a9289ad56bd10f1509b7fe65001d00204d03aa2719bb08173111e8bdb4975b4b861dba3cc712d8cb953f85570324894a0012000000170000000b0002010044cd00050003026832000d0012001004030804040105030805050108060601000a000c000a2a2a11ec001d001700180000001900170000147777772e776f6c6672616d616c7068612e636f6d002d00020101fe0d011a0000010001a60020242692fbd8790e20f6f268a9f4da497a69aa68484daba6826a9a7b25a647a42000f0d6e69f521d91e7b9de84d3a14d45ee222152debd94c51d106855013dce497c7da648af5e12f128de83a3042a68a5d9167b7a1c7e9995570378d5dfdf30da79430df4346e47e665fad562dd56c417a1b2d9cdeb51156392abb45a800e8cd1f990c8a5619e02b28da550bd727d6e50ef8974ac00a021fce5ef70494450d495ca2319c3c5a8581ab53a73307309dc7b6a7fd719c138ab3c0c3eb7bfe86e0362f96c8c6c0dedab6ce9b537a71e7938372feef7a0d85c29a67ca731392ad30d5deeaa656b20ba2642427d1dc5c95a17b3eec8d017847c8e51fd40348fcb027c83592ee9f6e03e3c58de8ac1303496bb2cc5120010000e000c02683208687474702f312e31001b00030200026a6a000100")

    ws_client_hello = bytes.fromhex("160301071d0100071903030620ffa650bedd452bf332a1f7432fa5f5e1da47de91551884a12dccdf29de9920d9aaea3200eb5cb4c4c05f53f7f7a1efed7b1d04516a3eba35f2aea48630dfe600203a3a130113021303c02bc02fc02cc030cca9cca8c013c014009c009d002f0035010006b01a1a0000002b000706dada0304030300230000000500050100000000ff01000100003304ef04ed2a2a00010011ec04c0fc689487859242f2b24f2c92b90aaf1642bb47712918a97deb465ed98b3fc700101f1a5e322267196a5a682a5a6b011c1e84211824c36cec62d6884d82a1cb826bad7d457bf6b37e869a5b291881cc76aead8b06458282f1460b073206c1d71e939ac4876a1dfa2267d88b01d91caf0ca60d4184548fb7ba390a85604449004c3b8df53518f85b212b85e4195c05b921954bcb55f013a8d722de6093d34773a6a507f6e8bc3f744611b408a1a26b52b90aa3a0637518ce11e94949d45f88e948af7bcb25b32d5c946a7f6059512b7871a91a9fa6915a762592f66b020429045250b72c385187074d132b34b91de2975d8a285bd6c024da5013ec99ccc239b23cc0529e052f2c6959b4569be162545e561fb1929a5e4463a3550828f18fe6655f47f69db23bca35d0577729176468384feaa96a4346a506766150364f6647a50061a3e983f0669217ac925b621481abc70cda0be04b2929ebb008b0473d708f2adbb20872ccf0f45694003471c51f16b38f9b007f0c352d6d94b50ed412e7c61b7faa34c74914d1197ecd1806918309b4bb20a5ec0a134715ae87c461668bff8ca5cdd4abeef91082b38d58631a536a1f691a4dbe212380e15f532a91e8d24bb65b5fc10754880624ace8c7ae7933cdd6103968c733caaa2684a96455cf9c50948e971dd81c7e9e775525556f4407caafaac349c9c163f65f5c6bb8f093802562501c1a6c2a41683b0b13f645cf4be48fff22a7f7144a22b527389419134836501212698a3fde328975184a9c6a67f4914c50e26d1dd438c9c820eff073c5d11fba5926fd105668186bc11a1462416d1d242bca785981928ab3473299407df76a59c4c9a25330a4eb477e23a325712114b58931659c652560584eab1d18836c5ecc7ff57a558443ab02b077ef26962d22af58739665832b6a8b3f6df100c774018424344c9629400aa1e8a97b0ae67d997411d8a538fe2a49b7e7370cbc88a673b3f89561f748ace1b5712da7c49ab3c49b0209c6e03e608153c9b686d1911413479b1488a0448874b77486a7a191d1b54dcef10bd2a3a9d8ab984771bae270c2e0a19a1b792b98226321e2b0d8a78a6f768592a96e6a557e088a18d81b434b1133aaa478503c56111194b4192736fb5def40cf1c564c710c169045a17b2434507a2daa38b55649aa91768f988a0c09da387a148051e36d1bd39dbaf7607dca8ab2b33546869cbb328951b73728c98c1a6c61c746cf1d576391882d1c4ba729745424a2c5038b6548c4aa91a754a6ba233fcb61d657333aeb4747f4be649a658fcc96e5019538934538162f22c69f7da4856e2b934c5219db9829222738fcf49a1f76491ceb4294d7a92d981ce45cbd5b87965cba1bba18ae81e0314ad7bae41c78894147655304dc28a6abb271aa6149b8f78277e4402088ce8d198998b9ad7ddc18e5045bb8149f18ea1ec95619ba29cc05c91c434bcdbbdc766b276119f32c53c4b276d975167a35ead11d86b5a31873b1c39a575c0856d9a3b8d88549b6939a2cd32193710286f15b613ab6de467599e67a063031755956d7da5a94189caf513350e92cbe39890ce091176159a8671d63108dc93a77553bb962151ad37295e417af4407950c654a791e404d4b7ec9bcaa050a0faf3255ee5e30000ebdb74901afdbe718318d55016f5e6c09db4a77dad2d0c4a9289ad56bd10f1509b7fe65001d00204d03aa2719bb08173111e8bdb4975b4b861dba3cc712d8cb953f85570324894a0012000000170000000b0002010044cd00050003026832000d0012001004030804040105030805050108060601000a000c000a2a2a11ec001d001700180000001900170000147777772e776f6c6672616d616c7068612e636f6d002d00020101fe0d011a0000010001a60020242692fbd8790e20f6f268a9f4da497a69aa68484daba6826a9a7b25a647a42000f0d6e69f521d91e7b9de84d3a14d45ee222152debd94c51d106855013dce497c7da648af5e12f128de83a3042a68a5d9167b7a1c7e9995570378d5dfdf30da79430df4346e47e665fad562dd56c417a1b2d9cdeb51156392abb45a800e8cd1f990c8a5619e02b28da550bd727d6e50ef8974ac00a021fce5ef70494450d495ca2319c3c5a8581ab53a73307309dc7b6a7fd719c138ab3c0c3eb7bfe86e0362f96c8c6c0dedab6ce9b537a71e7938372feef7a0d85c29a67ca731392ad30d5deeaa656b20ba2642427d1dc5c95a17b3eec8d017847c8e51fd40348fcb027c83592ee9f6e03e3c58de8ac1303496bb2cc5120010000e000c02683208687474702f312e31001b00030200026a6a000100")
    
    wh_pac = TLSStreamParser(ws_client_hello)
    try:
        wh_pac.parse()
    except Exception as e:
        print("Parsing error: ", e)
    print(wh_pac)

    pkt = bytes.fromhex("160303007a0200007603034e1b01187e378d7b5c5818e494fae58b5d936b45a92ac55336bf8de4c3ce7d6d2046ca723e507341408993f1ba14e2594a5f878a75cb4eca7877aa48f7e511688b130100002e00330024001d0020408edfe8414885d8be99d88f3d3805851ca21b04a482f0cf0f9a2669bd7da019002b000203041403030001011703030f14694d63db6fcd6572b1d6e990c4732890ed96207eaf6a64830f0525a7569ac7c7460048067e5ca683187302523b58b4871837532d6282f326bbe7eda4ed5bdf83071dc3b4403040d1d075532077f5a08cfef561bcffa203ef847119712000024ff30dbc6395d1d3c76044c5f3abb05b142b3a9bedcea661f4974b5c823ebb91dc2c68190cda3b45ccf4b3acca6360596fadcf0e064a28ca26de4d143dc60172cea3f841d328bf137e77bd79a19e6a3f85416d89577165ac822b82a086b79af7929449dbee421eed3d90ad5582cd507e494772c72f01e9b52581bb960445d52910adb98494c501650ad4baa0844991c5798d4dceb6541f21b696ab9e2223288c5f9807fb5302dd67aa0d3c1e7de6b5d785415ff2d9facc0721a23b7a4f14a4c5a895795baecff87df7e3c05d38e2fe634d90be94329ac86ba667b054671dadff40e75680634265023671c0e6e984246f27506026749c6bcfceeee90fae4fb48287d63144045b93a9eb1209336217e029a5a8be41cf38bfab911ffc2a769169fc2881ded4b832ed065d73702f0139adb6223128c02c7117d76cb461631bf930f4bf98d60953ef9e55abcd257c61082c6fc5fbf15b76208e5384f031b958ef9ba676d03524238d5127dcdffd14f03ab30c21dd1ac228ad852a1f9e3408b1ada86b54df84141ad778a4f8881be0dfce5cbea104287f8d2500cf2c507bd2d8beed23bda912324834d1996f766935679325988b434c5c3b5cbfdf7bde79db3db29352a81ac82ce978cbd9a2495cef8abadfaf7a5f1c3caef54757552ab171d4622f3a16f41cdef7c972a901d6eca0621d5be66f10bdfd9bf8a8ef2dbc2b58b1e0fbe0884f91709282b86505da4cb34facfffa7ea07bc558457a4fa832520065446d3013133cf607e029194e8be1486c916441e10bc7906df3c4783ea33d0b012533c1a9c30b9bd05adfb15fdb88eff15d0809a1484143626051f506c81a5189d236e79bfca7bbee47a7a6b07f45f2a37fd50ff839cae7cde875ab2703024292c6942342845ed542e6c00dfe3a0447d360c57ad00b6724cc6176ab63ac71cd2759cbeb34898d156738f02f3bb537dc79f47d667e33e9b1c9b19917989f7ec3a5c5900c82fe18f8af78760bb79bea91d539c7ad1f40028425be7087d2ce6c9119dcb40631e904842d8d2344ad90ab5198f22914971b8b43c2378681b19ee037a8bc80b4515f4e94e20e416fb1a1550a6b4f3803cd864ae8a1364827db2bad1614a92fe5505b6a5227feace20d97e289393c0b691c3a6f31e43e62629a71b75041207528f991f0e438173a6c50419de75f9a9d80225191df910c0958d578478934c9e9c09204b21c9ca871146554c3586d97f72fca966af68aff3e10f2ac8c5e88f59c4fe054ab1a9d1004352201bb1a204d8dd9650ab5f032921bc74d33b3b967db0f95f77e0109c4865d2cbb4f6226337568e631b5fd7a6edd634f5ff0065cb51e5daeb73910ef5a754a6eac5be24d4e2cd7261b20b819ea52d0d98d192bd97a5ab49e1f5913df7d37749efd1c872d2b3608a8202b29a1da98b642ddfdaf90e17c3e1bb673104a1c9097c03d1b82149664e1b840803e2468f5b340c5f9e0ea927effdda344d19ebf9906564d0403eaeb7b94188617ee71dabaafe14054450c36c015c477dfe5bd41a2382191d14ad03e29e4e783f6492774259fd655bf3b45e792a1f25320dda7633bde0cf25e35e6a76ee62868b36f3959b3f2282da87ab631e28ffb413590d151b4a5c5014398e689e34ce935779cef3a56e413b613b0abf6ca6dd95626968bc04ed95ab33c94e7bc061afc608797723a1be5")
    
    packet = TLSStreamParser(pkt)
    try:
        packet.parse()
    except Exception as e:
        print("Parsing error: ", e)
    print(packet)

    # test_sample = TLSRecord(sample)
    # try:
    #     test_sample.parse()
    # except Exception as e:
    #     print("Parsing error", e)
    #     sys.exit()
    #     signal.alarm(5)
    # print(test_sample)

    # for pkt in wireshark_packets:
    #     p = bytes.fromhex(pkt)
    #     packet = TLSRecord(p)
    #     try:
    #         packet.parse()
    #     except Exception as e:
    #         print("Parsing error: ", e)
    #     print(f"{packet} \n")
    # #test_tls_payload_parsing()

    # test_packets = []
    # test_packets.append(sample_alert)
    # test_packets.append(sample_css)
    # test_packets.append(sample_client_hello)
    # test_packets.append(sample_server_hello)
    
    # for pkt in client_hellos:
    #     packet = bytes.fromhex(pkt)
    #     test_packets.append(packet)
    # for pkt in server_hellos:
    #     packet = bytes.fromhex(pkt)
    #     test_packets.append(packet)
    # for pkt in truncated:
    #     packet = bytes.fromhex(pkt)
    #     test_packets.append(packet)
    # for pkt in wireshark_packets:
    #     packet = bytes.fromhex(pkt)
    #     test_packets.append(packet)

    # log_file = "tools/tls_parse_sample_data_results.txt"
    # with open(log_file, "w") as log:
    #     for index, value in enumerate(test_packets):
    #         packet = TLSRecord(value)
    #         log.write(f"----------Parsing packet no: {index} -----------\n")
    #         try:
    #             packet.parse()
    #             log.write(f"{packet} \n")
    #         except Exception as e:
    #             log.write(f"Failed to parse {index}: {e.__class__.__name__} - {e}")





# testing packets extracted from tcpdump capture
def test_tls_payload_parsing(payloads_dir="tools/tls_payloads", log_file="tools/tls_parse_results.txt"):
    with open(log_file, "w") as log:
        for filename in os.listdir(payloads_dir):
            file_path = os.path.join(payloads_dir, filename)
            with open(file_path, "rb") as f:
                data = f.read()
            log.write(f"\n --- Parsing: {filename} ---")
            #print(f"\n --- Parsing: {filename} ---")
            
            try:
                record = TLSRecord(data)
                record.parse()
                log.write(str(record) + "\n")
                #print(record)
            except Exception as e:
                log.write(f"Failed to parse {filename}: {e.__class__.__name__} - {e}")
                #print(f"Failed to parse {filename}: {e.__class__.__name__} - {e}")

if __name__ == "__main__":
    #main()
    run_gui()
